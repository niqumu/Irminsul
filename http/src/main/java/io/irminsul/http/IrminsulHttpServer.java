package io.irminsul.http;

import io.irminsul.common.http.HttpServer;
import io.irminsul.common.http.DispatchRegion;
import io.irminsul.http.handler.*;
import lombok.Getter;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import spark.Service;
import spark.Spark;

import java.util.List;

@Getter
public class IrminsulHttpServer implements HttpServer {

    /**
     * This server's logger
     */
    private final Logger logger = LoggerFactory.getLogger("HTTP Server");

    /**
     * The {@link Spark} instance of this web server
     */
    private final Service spark = Service.ignite();

    /**
     * The port this web server is running on
     */
    private final int port;

    /**
     * A list of regions registered on this web server
     */
    private final List<DispatchRegion> regions = List.of(
        new DispatchRegion("os_usa", "Irminsul", "127.0.0.1", 22102)
    );

    public IrminsulHttpServer(int port, boolean ssl) {
        this.port = port;

        // Set up HTTPS
        if (ssl) {
            this.spark.secure("keystore.jks", "password", null, null);
        }

        // Start the server
        this.spark.port(this.port);
        this.spark.init();
        this.logger.info("HTTP server started on port {}", this.port);

        // Set up region handlers
        this.spark.get("/query_security_file", new QuerySecurityFileHandler(this));
        this.spark.get("/query_region_list", new QueryRegionListHandler(this));
        this.spark.get("/query_cur_region/:region", new QueryCurrentRegionHandler(this));

        // Set up login handlers

        // Used to check login "risk", determines whether the user needs to do a captcha or not
        // Hardcoded to return no risk, no captcha
        this.spark.post("/account/risky/api/check", (request, response) -> {
            response.type("application/json");
            return "{\"data\":{\"action\":\"ACTION_NONE\",\"geetest\":null,\"id\":\"1\"},\"message\":\"OK\",\"retcode\":0}";
        });

        // Used to generate a login token
        this.spark.post("/hk4e_global/mdk/shield/api/login", new LoginHandler(this));

        // Used to log in with a fresh login token generated by /hk4e_global/mdk/shield/api/login
        this.spark.post("/hk4e_global/combo/granter/login/v2/login", new LoginComboHandler(this));

        // Used to log in with a cached login token generated by /hk4e_global/mdk/shield/api/login
        this.spark.post("/hk4e_global/mdk/shield/api/verify", (request, response) -> {
            this.logger.info("verify request"); // TODO
            return null;
        });

        // Set up logging handlers
        this.spark.post("/crash/dataUpload", (request, response) -> null);
        this.spark.post("/log", new LogHandler(this));

        // Set up root handler
        this.spark.get("/", (request, response) -> "Irminsul PS");
    }
}
