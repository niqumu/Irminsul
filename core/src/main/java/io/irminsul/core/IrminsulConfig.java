package io.irminsul.core;

import io.irminsul.common.config.Config;
import io.irminsul.common.config.ConfigEntry;
import lombok.NonNull;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.*;
import java.util.HashMap;
import java.util.Map;
import java.util.Properties;

/**
 * Simple {@link Config} implementation using {@code settings.property} in the run directory
 * @see ConfigEntry configuration keys
 */
public class IrminsulConfig implements Config {

    /**
     * Static final String of the configuration file name used by Irminsul
     */
    private static final String CONFIG_FILE = "settings.properties";

    /**
     * The logger associated with this instance, used to log errors when reading or parsing
     */
    private final Logger logger = LoggerFactory.getLogger("Config");

    /**
     * The configuration itself, stored as a map of {@link ConfigEntry} {@code -> Object}
     */
    private final Map<ConfigEntry, Object> config = new HashMap<>();

    /**
     * Gets a value from the config, keyed by {@link ConfigEntry}
     * @param key The {@link ConfigEntry} to lookup
     * @return The value associated with the provided key in this configuration
     */
    public @NonNull String getValue(@NonNull ConfigEntry key) {
        return (String) this.config.getOrDefault(key, key.getDefaultValue());
    }

    /**
     * Sets a value in the config, keyed by {@link ConfigEntry}
     * @param key The {@link ConfigEntry} to set
     * @param value The new value to associate with the provided key
     */
    public void setValue(@NonNull ConfigEntry key, @NonNull Object value) {
        this.config.put(key, value);
    }

    /**
     * Load the configuration file
     * @throws IOException If something went wrong
     */
    public void load() throws IOException {
        File propertiesFile = new File(CONFIG_FILE);

        if (!propertiesFile.exists()) {
            this.logger.info("Configuration file missing - creating a new one with default values!");
            this.save();
        }

        Properties properties = new Properties();
        properties.load(new FileInputStream(propertiesFile));

        for (ConfigEntry entry : ConfigEntry.values()) {
            Object value = properties.getOrDefault(entry.getKey(), entry.getDefaultValue());
            this.config.put(entry, value);
        }
    }

    /**
     * Saves the configuration file
     * @throws IOException If something went wrong
     */
    public void save() throws IOException {
        File propertiesFile = new File(CONFIG_FILE);
        Properties properties = new Properties();

        // Iterate over each entry, storing either the loaded value or the default value
        for (ConfigEntry entry : ConfigEntry.values()) {
            if (this.config.containsKey(entry)) {
                properties.put(entry.getKey(), String.valueOf(this.config.get(entry)));
            } else {
                properties.put(entry.getKey(), String.valueOf(entry.getDefaultValue()));
            }
        }

        properties.store(new FileOutputStream(propertiesFile), "Generated by Irminsul " + Irminsul.SERVER_VERSION);
    }
}
